<html>

<head>
    <title>图片</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">

    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.2/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.0/css/jquery-weui.min.css">
    <!--script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.0/js/jquery-weui.min.js"></script-->
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-weui.min.js"></script>
    <link rel="stylesheet" href="css/cropper.min.css">
    <script src='js/cropper.min.js'></script>
    <script src="js/canvas-to-blob.js"></script>
</head>

<body>
    <input id="btn1" type="file" accept="image/*,camera" style="opacity: 0;" />
    <p style="text-align: center;font-size: 20px;">修改头像</p>

    <div class="upload-img" style="width:100%;height: 60%;">
        <img src="photo2.php?action=get" />
    </div>
    <div style="margin-bottom: 60px">
        <div class="weui-btn-area">
            <a class="weui-btn weui-btn_primary" href="javascript:void(0)" id="upload_btn">选择</a>
        </div>
        <div class="weui-btn-area">
            <a class="weui-btn weui-btn_primary" href="javascript:void(0)" id="image_save">上传</a>
        </div>
        <img id="preview" style="visibility: hidden" />
    </div>
    <div class="weui-tabbar" style="position: fixed">
        <a href="./danmu.php" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="./src/msg1.svg" alt="">
            </div>
            <p class="weui-tabbar__label">弹幕</p>
        </a>
        <a href="javascript:void(0)" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="./src/money1.svg" alt="">
            </div>
            <p class="weui-tabbar__label">投票</p>
        </a>
        <a href="./me.php" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="./src/me1.svg" />
            </div>
            <p class="weui-tabbar__label">我</p>
        </a>
    </div>
    <script type="text/javascript">
        $(function() {
            //触发input file
            $('#upload_btn').click(function() {
                $('#btn1').trigger('click');
            });

            //图片上传
            var $image = $('.upload-img > img');
            $image.cropper({
                viewMode: 1,
                aspectRatio: 1, //裁剪比例，NaN-自由选择区域
                autoCropArea: 1, //初始裁剪区域占图片比例
                crop: function(data) { //裁剪操作回调
                }
            });
            var fileName; //选择上传的文件名
            $('#btn1').change(function() {
                var file = this.files[0];
                fileName = file.name;
                var reader = new FileReader();
                //reader回调，重新初始裁剪区
                reader.onload = function() {
                    // 通过 reader.result 来访问生成的 DataURL
                    var url = reader.result;
                    //选择图片后重新初始裁剪区
                    $image.cropper('reset', true).cropper('replace', url);
                };
                reader.readAsDataURL(file);
            });

            /*
             * 上传图片
             */
            $('#image_save').click(function() {
                var type = $image.attr('src').split(';')[0].split(':')[1];

                var canVas = $image.cropper("getCroppedCanvas", {});
                //将裁剪的图片加载到face_image
                //$('#preview').attr('src', canVas.toDataURL());
                canVas.toBlob(function(blob) {
                    var formData = new FormData();
                    formData.append("file", blob);
                    $.ajax({
                        type: "POST",
                        url: 'photo2.php?action=upload',
                        data: formData,
                        contentType: false, //必须
                        processData: false, //必须
                        dataType: "json",
                        success: function(data) {
                            $.toast("上传成功");
                            setTimeout("window.location = 'me.php';", 2 * 1000);

                        },
                        error: function(a) {
                            $.toast("上传失败，不如换个图片试试", "cancel");
                        }
                    });
                }, type);
            });
        });
    </script>
</body>

</html>